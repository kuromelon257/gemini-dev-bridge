javascript:(function(){if(document.getElementById("gdb-bookmarklet")){return;}const SKEY="gdb_settings";const D={serverUrl:"http://127.0.0.1:17831",token:""};function load(){try{const r=localStorage.getItem(SKEY);if(!r){return Object.assign({},D);}return Object.assign({},D,JSON.parse(r));}catch{return Object.assign({},D);}}function save(s){localStorage.setItem(SKEY,JSON.stringify(s));}function cfg(){const c=load();const url=prompt("Gemini Dev Bridge: サーバURL",c.serverUrl);if(url===null){return null;}const token=prompt("Gemini Dev Bridge: トークン",c.token);if(token===null){return null;}const n={serverUrl:url.trim()||D.serverUrl,token:token.trim()};save(n);return n;}function ensure(){const c=load();if(!c.token){const n=cfg();if(!n){throw new Error("トークンが未設定です。設定してください。");}return n;}return c;}function toast(m){let t=document.getElementById("gdb-bookmarklet-toast");if(!t){t=document.createElement("div");t.id="gdb-bookmarklet-toast";document.body.appendChild(t);}t.textContent=m;setTimeout(()=>t.remove(),5000);}function styles(){if(document.getElementById("gdb-bookmarklet-style")){return;}const s=document.createElement("style");s.id="gdb-bookmarklet-style";s.textContent="#gdb-bookmarklet{position:fixed;right:16px;bottom:16px;z-index:9999;display:flex;flex-direction:column;gap:8px;font-family:'Segoe UI','Yu Gothic UI',sans-serif}.gdb-bm-btn{background:#111827;color:#f9fafb;border:1px solid #374151;border-radius:999px;padding:10px 16px;font-size:12px;cursor:pointer;box-shadow:0 6px 16px rgba(0,0,0,.2)}.gdb-bm-btn.primary{background:#f97316;border-color:#fdba74;color:#fff;font-weight:700;box-shadow:0 8px 18px rgba(249,115,22,.35)}.gdb-bm-inline{display:inline-flex;align-items:center;gap:8px;margin:8px 0;padding:8px 12px;border-radius:10px;border:2px solid #f59e0b;background:#fff7ed;font-size:12px;font-weight:600;color:#7c2d12;box-shadow:0 6px 16px rgba(245,158,11,.2)}.gdb-bm-inline button{border:none;border-radius:999px;padding:8px 14px;background:#f97316;color:#fff;cursor:pointer;font-size:12px;font-weight:700}#gdb-bookmarklet-toast{position:fixed;right:16px;bottom:80px;background:rgba(17,24,39,.95);color:#f9fafb;padding:10px 14px;border-radius:8px;font-size:12px;max-width:320px;z-index:10000;line-height:1.4}";document.head.appendChild(s);}function vis(e){return !!(e.offsetWidth||e.offsetHeight||e.getClientRects().length);}function findInput(){const q=Array.from(document.querySelectorAll("rich-textarea .ql-editor[contenteditable='true'], .ql-editor[contenteditable='true']")).filter(vis);if(q.length>0){return q[q.length-1];}const c=Array.from(document.querySelectorAll("textarea, div[contenteditable='true']")).filter((e)=>vis(e)&&!e.classList.contains("ql-clipboard"));if(c.length===0){return null;}return c[c.length-1];}function setText(el,text){if(!el){return false;}if(el.tagName.toLowerCase()==="textarea"){el.value=text;el.focus();el.selectionStart=el.value.length;el.selectionEnd=el.value.length;el.dispatchEvent(new Event("input",{bubbles:true}));return true;}if(el.isContentEditable){el.textContent=text;el.focus();const r=document.createRange();r.selectNodeContents(el);r.collapse(false);const s=window.getSelection();if(s){s.removeAllRanges();s.addRange(r);}el.dispatchEvent(new Event("input",{bubbles:true}));return true;}return false;}function looks(text){return text.includes("diff --git")||(text.includes("--- ")&&text.includes("+++ "))||text.startsWith("@@ ");}function extract(){const blocks=Array.from(document.querySelectorAll("pre code"));for(let i=blocks.length-1;i>=0;i--){const t=(blocks[i].textContent||"").trim();if(t&&looks(t)){return t;}}const pres=Array.from(document.querySelectorAll("pre"));for(let i=pres.length-1;i>=0;i--){const t=(pres[i].textContent||"").trim();if(t.includes("diff --git")){return t;}}return null;}async function snap(){const s=ensure();const url=new URL("/snapshot",s.serverUrl);const res=await fetch(url.toString(),{headers:{"X-Local-Token":s.token||""}});if(!res.ok){const t=await res.text();throw new Error(t||"Snapshot取得に失敗しました。");}return res.json();}async function applyDiff(d){const s=ensure();const url=new URL("/apply",s.serverUrl);const res=await fetch(url.toString(),{method:"POST",headers:{"Content-Type":"application/json","X-Local-Token":s.token||""},body:JSON.stringify({diff_text:d})});const text=await res.text();const data=(()=>{try{return JSON.parse(text);}catch{return {message:text};}})();if(!res.ok){throw new Error(data.message||data.detail||"diff適用に失敗しました。");}return data;}function attach(){const blocks=Array.from(document.querySelectorAll("pre code"));blocks.forEach((code)=>{if(code.dataset.gdbApplyAttached==="1"){return;}const text=(code.textContent||"").trim();if(!text||!looks(text)){return;}const pre=code.closest("pre");if(!pre){return;}const wrap=document.createElement("div");wrap.className="gdb-bm-inline";const label=document.createElement("span");label.textContent="差分を検出しました";const btn=document.createElement("button");btn.type="button";btn.textContent="この差分を適用";btn.addEventListener("click",async()=>{toast("diff適用中...");try{const r=await applyDiff(text);const f=(r.changed_files||[]).join(", ");toast(`適用しました。変更: ${f||"(なし)"}`);}catch(e){toast(e.message||"diff適用に失敗しました。");}});wrap.appendChild(label);wrap.appendChild(btn);pre.parentElement.insertBefore(wrap,pre);code.dataset.gdbApplyAttached="1";});}function observe(){attach();const o=new MutationObserver(()=>attach());o.observe(document.body,{childList:true,subtree:true});}function panel(){const c=document.createElement("div");c.id="gdb-bookmarklet";const b1=document.createElement("button");b1.className="gdb-bm-btn primary";b1.textContent="スナップショット貼り付け";b1.addEventListener("click",async()=>{toast("スナップショット取得中...");try{const d=await snap();const el=findInput();if(!setText(el,d.text)){toast("入力欄が見つかりません。GeminiのUI変更に注意してください。");return;}toast("貼り付け完了しました。");}catch(e){toast(e.message||"Snapshot取得に失敗しました。");}});const b2=document.createElement("button");b2.className="gdb-bm-btn";b2.textContent="差分を抽出して適用";b2.addEventListener("click",async()=>{toast("diff抽出中...");const d=extract();if(!d){toast("diffブロックが見つかりません。Geminiの返信を確認してください。");return;}try{const r=await applyDiff(d);const f=(r.changed_files||[]).join(", ");toast(`適用しました。変更: ${f||"(なし)"}`);}catch(e){toast(e.message||"diff適用に失敗しました。");}});const b3=document.createElement("button");b3.className="gdb-bm-btn";b3.textContent="設定";b3.addEventListener("click",()=>{const n=cfg();if(n){toast("設定を保存しました。");}});c.appendChild(b1);c.appendChild(b2);c.appendChild(b3);document.body.appendChild(c);}styles();panel();observe();})();
